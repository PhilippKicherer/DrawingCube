<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>AR Würfel mit Hiro Marker</title>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.rawgit.com/jeromeetienne/ar.js/1.7.7/aframe/build/aframe-ar.min.js"></script>
  <style>
    #throwButton {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      font-size: 18px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      z-index: 9999;
      cursor: pointer;
    }
  </style>
</head>
<body style="margin:0; overflow:hidden;">
  <button id="throwButton">Würfeln</button>

  <a-scene
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false;"
    vr-mode-ui="enabled: false"
  >
    <!-- Kamera -->
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- Hiro Marker -->
    <a-marker type="pattern" url="https://raw.githubusercontent.com/AR-js-org/AR.js/master/three.js/examples/marker-training/examples/pattern-files/pattern-hiro.patt">

      <!-- Würfel -->
      <a-box id="dice" position="0 0.5 0" rotation="0 0 0" depth="0.5" height="0.5" width="0.5" color="#FF0000" material="opacity: 0.8;">
        <!-- Seitenzahlen als Text-Entities (optional) -->
        <a-text value="1" position="0 0.3 0.26" rotation="0 0 0" align="center" color="white"></a-text>
        <a-text value="6" position="0 -0.3 -0.26" rotation="0 180 0" align="center" color="white"></a-text>
        <a-text value="2" position="0.26 0 0" rotation="0 90 0" align="center" color="white"></a-text>
        <a-text value="5" position="-0.26 0 0" rotation="0 -90 0" align="center" color="white"></a-text>
        <a-text value="3" position="0 0.26 0" rotation="90 0 0" align="center" color="white"></a-text>
        <a-text value="4" position="0 -0.26 0" rotation="-90 0 0" align="center" color="white"></a-text>
      </a-box>

    </a-marker>
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const dice = document.querySelector('#dice');
    const button = document.querySelector('#throwButton');

    // Würfelseiten in Euler-Rotation, damit die entsprechende Seite oben liegt
    // Diese Rotationen sind grob angepasst:
    const diceSides = [
      { name: "1", rotation: { x: 0, y: 0, z: 0 } },
      { name: "2", rotation: { x: 0, y: -90, z: 0 } },
      { name: "3", rotation: { x: 90, y: 0, z: 0 } },
      { name: "4", rotation: { x: -90, y: 0, z: 0 } },
      { name: "5", rotation: { x: 0, y: 90, z: 0 } },
      { name: "6", rotation: { x: 180, y: 0, z: 0 } },
    ];

    let isThrowing = false;

    function animateThrow(targetRotation, duration = 1500) {
      return new Promise((resolve) => {
        let startTime = null;

        const initialRotation = dice.getAttribute('rotation');
        // Animation mit requestAnimationFrame
        function animate(time) {
          if (!startTime) startTime = time;
          let elapsed = time - startTime;
          let t = Math.min(elapsed / duration, 1); // progress 0..1

          // Leicht beschleunigt mit ease out (quadratisch)
          const easeOutT = 1 - (1 - t) * (1 - t);

          // Interpolieren der Rotation
          const newRot = {
            x: initialRotation.x + (targetRotation.x - initialRotation.x) * easeOutT + 720 * easeOutT, // 2 volle Umdrehungen x-Achse
            y: initialRotation.y + (targetRotation.y - initialRotation.y) * easeOutT + 720 * easeOutT, // 2 volle Umdrehungen y-Achse
            z: initialRotation.z + (targetRotation.z - initialRotation.z) * easeOutT + 720 * easeOutT, // 2 volle Umdrehungen z-Achse
          };
          dice.setAttribute('rotation', newRot);

          if (t < 1) {
            requestAnimationFrame(animate);
          } else {
            // Am Ende exakte Zielrotation setzen (ohne die 720 Grad extra)
            dice.setAttribute('rotation', targetRotation);
            resolve();
          }
        }
        requestAnimationFrame(animate);
      });
    }

    button.addEventListener('click', async () => {
      if (isThrowing) return; // blockieren, falls schon animiert
      isThrowing = true;

      // Zufällige Seite auswählen
      const randomIndex = Math.floor(Math.random() * diceSides.length);
      const side = diceSides[randomIndex];

      // Würfeln animieren
      await animateThrow(side.rotation);

      alert(`Gewürfelt: ${side.name}`);

      isThrowing = false;
    });
  </script>
</body>
</html>
